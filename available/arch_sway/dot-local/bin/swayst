#!/bin/env bash
set -euo pipefail
trap 'kill 0' SIGINT
trap 'kill 0' SIGSTOP

function fmt() {
  echo "{\"full_text\":\"$1\", \"color\":\"$2\"}"
}

function cached() {
  fn=$1
  timeout=$2
  file_name=$(echo "$@" | md5sum | awk "{print \"/tmp/${1}_\" \$1}")
  shift
  shift
  if [[ ! -f "$file_name" || $(($(date +%s) - $(stat -c %Y "$file_name" 2>/dev/null))) -gt "$timeout" ]]; then
    result=$("$fn" "$@")
    echo "$result" >"$file_name"
  else
    read result <"$file_name"
  fi
  echo $result
}

function color_grad_asc() {
  n=$1
  if ((n >= 0 && n <= 9)); then
    echo "#a9b1d6"
  elif ((n >= 10 && n <= 19)); then
    echo "#7aa2f7"
  elif ((n >= 20 && n <= 29)); then
    echo "#0db9d7"
  elif ((n >= 30 && n <= 49)); then
    echo "#9ece6a"
  elif ((n >= 50 && n <= 69)); then
    echo "#e0af68"
  elif ((n >= 70 && n <= 100)); then
    echo "#f7768e"
  else
    echo "#ffffff"
  fi
}

function color_grad_desc() {
  n=$1
  if ((n >= 90 && n <= 100)); then
    echo "#a9b1d6"
  elif ((n >= 80 && n <= 89)); then
    echo "#7aa2f7"
  elif ((n >= 70 && n <= 79)); then
    echo "#0db9d7"
  elif ((n >= 50 && n <= 69)); then
    echo "#9ece6a"
  elif ((n >= 30 && n <= 49)); then
    echo "#e0af68"
  elif ((n >= 0 && n <= 29)); then
    echo "#f7768e"
  else
    echo "#ffffff"
  fi
}

function cpu_load() {
  load=$(cat /proc/loadavg | awk '{printf "%i", $1 / 8 * 100}')
  fmt "Cpu: ${load}%" "$(color_grad_asc "$load")"
}

function mem_free() {
  mem_usage=$(awk '/MemFree/{free=$2} /MemTotal/{total=$2} END{print int(((total-free)*100)/total)}' /proc/meminfo)
  fmt "Mem: ${mem_usage}%" "$(color_grad_asc "$mem_usage")"
}

function bat_stat() {
  read capacity <"/sys/class/power_supply/BAT0/capacity"
  read status <"/sys/class/power_supply/BAT0/status"
  bat_st=$(case "$status" in
    "Charging")
      echo ""
      ;;
    "Full" | "Not charging")
      echo ""
      ;;
    "Discharging")
      echo "󰚦"
      ;;
    *)
      echo ""
      ;;
    esac)
  fmt "Bat: ${bat_st}${capacity}%" "$(color_grad_desc "$capacity")"
}

function disk_stat() {
  load=$(df | grep nvme0n1p2 | head -n1 | awk '{print $5}' | tr -d '%')
  fmt "Disk: ${load}%" "$(color_grad_asc "$load")"

}

LAYOUT_FILE="/tmp/sway-layout"
function layout() {
  read layout <"$LAYOUT_FILE"

  color="#ffffff"
  country=$(if [[ "$layout" == Eng* ]]; then
    echo "U.S."
  elif [[ "$layout" == Latv* ]]; then
    echo "LAT "
  else
    echo "RUS "
  fi)
  fmt "󰌓 $country" "$color"
}

bt_status() {
  status=$(bluetoothctl show | awk -F \:\  '/Powered/{print $2}')
  if [[ "$status" == yes ]]; then
    color="#0082FC"
  else
    color="#a9b1d6"
  fi

  fmt "" "$color"
}

bt_headset() {
  devices=$(bluetoothctl devices Connected)
  if [[ -n "$devices" ]]; then
    mac=$(echo "$devices" | awk '{print $2}' | head -n1)
    alias=$(echo "$devices" | awk '{ $1=$2=""; sub(/^  */, ""); print }')
    path="/org/bluez/hci0/dev_${mac//:/_}"
    bat=$(busctl get-property org.bluez "$path" org.bluez.Battery1 Percentage | awk '{print $2}')

    fmt "󰋎 $alias $bat%" "$(color_grad_desc bat)"
  fi
}

function trim() {
  var="$1"
  # trim leading whitespace
  var="${var#"${var%%[![:space:]]*}"}"
  # trim trailing whitespace
  var="${var%"${var##*[![:space:]]}"}"
  echo "$var"
}

function wifi_status() {
  wifi=$(iwctl station wlan0 show)
  ssid=$(echo "$wifi" | awk -F 'Connected network' '/Connected network/{print $2}')
  ssid=$(trim "$ssid")

  rssi=$(echo "$wifi" | awk -F 'AverageRSSI' '/AverageRSSI/{print $2}' | tr -d 'dBm')
  rssi=$(trim "$rssi")

  color=$(
    if ((rssi >= -30)); then
      echo "#a9b1d6"
    elif ((rssi >= -40)); then
      echo "#7aa2f7"
    elif ((rssi >= -50)); then
      echo "#0db9d7"
    elif ((rssi >= -60)); then
      echo "#9ece6a"
    elif ((rssi >= -70)); then
      echo "#e0af68"
    else
      echo "#f7768e"
    fi
  )
  if [[ -n "$ssid" ]]; then
    fmt "󰖩 $ssid" "$color"
  fi
}

function wclock_utc() {
  fmt "UTC $(date -u +%H:%M)" "#e0af68"
}

function calendar() {
  fmt "󰸘 $(date "+%a, %d %b 󰢗 %H:%M ")" "#a9b1d6"
}

# cached wclock_utc 100
function loop() {
  panel=(
    "$(cached cpu_load 10)"
    "$(cached mem_free 30)"
    "$(cached disk_stat 60)"
    "$(cached bat_stat 60)"
    "$(cached wifi_status 10)"
    # "$(cached bt_status 10)"
    "$(cached bt_headset 10)"
    "$(layout)"
    "$(cached calendar 10)"
  )
  echo "[{\"full_text\":\"\"}"
  for indicator in "${panel[@]}"; do
    if [[ -n "$indicator" ]]; then
      echo ",$indicator"
    fi
  done
  echo "],"
}

echo -e "{ \"version\": 1 }\n["
swaymsg -t subscribe -m '["tick","input"]' -r | while IFS= read -r line; do
  if [[ "$line" =~ \"first\" ]]; then
    loop
  elif [[ "$line" =~ xkb_active_layout_name && "$line" =~ 1:1:AT_Translated_Set_2_keyboard ]]; then
    loop
  fi
done
